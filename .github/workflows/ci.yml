name: CI Pipeline & Security

on:
  push:
    branches-ignore: [ main ]
  pull_request:
    types: [ opened, synchronize, reopened ]
    branches: [ main ]
  workflow_dispatch:

# Restrict default permissions to read-only for security
permissions: read-all

jobs:
  test:
    # On branch push, only run if commit message contains [run ci]; always run on PRs and manual dispatch
    if: github.event_name != 'push' || contains(github.event.head_commit.message, '[run ci]')
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read  # Required to checkout code

    steps:
    - name: Checkout code
      uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5
      with:
        submodules: true

    - name: Setup Node.js
      uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444 # v5
      with:
        node-version: '22.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Install Devbox
      uses: jetify-com/devbox-install-action@a0d2d53632934ae004f878c840055956d9f741b0 # v0.14.0
      with:
        enable-cache: true

    - name: Run linter
      run: devbox run -- npm run lint

    - name: Build project
      run: devbox run -- npm run build

    - name: Run unit tests
      run: npm run test:unit

    - name: Check if secrets are available
      id: secrets-check
      run: |
        if [ -n "${{ secrets.ANTHROPIC_API_KEY }}" ]; then
          echo "available=true" >> $GITHUB_OUTPUT
        else
          echo "available=false" >> $GITHUB_OUTPUT
          echo "::warning::API keys not available - this is expected for PRs from forks. A maintainer can manually trigger tests using the 'Test Fork PR' workflow."
        fi

    - name: Run integration tests (with automated cluster creation and server management)
      if: steps.secrets-check.outputs.available == 'true'
      run: devbox run -- npm run test:integration
      timeout-minutes: 30
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        DOT_AI_GIT_TOKEN: ${{ secrets.DOT_AI_GIT_TOKEN }}
        USE_LOCAL_EMBEDDINGS: "true"

    - name: Skip integration tests (fork PR)
      if: steps.secrets-check.outputs.available == 'false'
      run: |
        echo "::notice::Integration tests skipped - secrets not available for fork PRs"
        echo "A maintainer can manually run tests using: Actions → 'Test Fork PR (Manual)' → Run workflow"

  security:
    # On branch push, only run if commit message contains [run ci]; always run on PRs and manual dispatch
    if: github.event_name != 'push' || contains(github.event.head_commit.message, '[run ci]')
    name: Security Analysis
    runs-on: ubuntu-latest
    permissions:
      contents: read           # Required to checkout code
      security-events: write   # Required to upload CodeQL results

    steps:
    - name: Checkout code
      uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5
      with:
        submodules: true

    - name: Initialize CodeQL
      uses: github/codeql-action/init@45c373516f557556c15d420e3f5e0aa3d64366bc # v3
      with:
        languages: typescript

    - name: Setup Node.js
      uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444 # v5
      with:
        node-version: '22.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build project
      run: npm run build

    - name: Run dependency security audit
      run: npx --no-install better-npm-audit audit --level moderate

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@45c373516f557556c15d420e3f5e0aa3d64366bc # v3
