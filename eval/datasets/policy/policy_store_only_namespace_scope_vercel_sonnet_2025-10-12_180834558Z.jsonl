{"input":{"issue":"Create Kyverno policy: All deployments must specify replica count for high availability"},"output":"# MANDATORY SCHEMA-BY-SCHEMA ANALYSIS\n#\n# ReplicationController: HAS spec.replicas field → MUST generate rule\n# ReplicaSet: HAS spec.replicas field → MUST generate rule\n# Deployment: HAS spec.replicas field → MUST generate rule\n# clusters.postgresql.cnpg.io: HAS spec.instances field (equivalent to replicas) → MUST generate rule\n# HorizontalPodAutoscaler: NO replicas field (manages replicas dynamically) → Can skip\n# DaemonSet: NO replicas field (one pod per node) → Can skip\n# StatefulSet: HAS spec.replicas field → MUST generate rule\n# ClusterPolicyReport: NO replicas field (reporting resource) → Can skip\n# ResourceQuota: NO replicas field (quota management) → Can skip\n# scheduledbackups.postgresql.cnpg.io: NO replicas field (backup resource) → Can skip\n# PodDisruptionBudget: NO replicas field (disruption management) → Can skip\n# LimitRange: NO replicas field (resource limits) → Can skip\n# Pod: NO replicas field (single instance) → Can skip\n# Node: NO replicas field (infrastructure) → Can skip\n# ClusterPolicy: NO replicas field (policy resource) → Can skip\n# PolicyReport: NO replicas field (reporting resource) → Can skip\n# clusterpolicyreports.wgpolicyk8s.io: NO replicas field (reporting resource) → Can skip\n# ClusterEphemeralReport: NO replicas field (reporting resource) → Can skip\n# poolers.postgresql.cnpg.io: HAS spec.instances field → MUST generate rule\n# Service: NO replicas field (networking resource) → Can skip\n# ComponentStatus: NO replicas field (status resource) → Can skip\n# PersistentVolumeClaim: NO replicas field (storage resource) → Can skip\n# clusterephemeralreports.reports.kyverno.io: NO replicas field (reporting resource) → Can skip\n# policyreports.wgpolicyk8s.io: NO replicas field (reporting resource) → Can skip\n# CronJob: NO replicas field (creates jobs on schedule) → Can skip\n# IPAddress: NO replicas field (networking resource) → Can skip\n# PersistentVolume: NO replicas field (storage resource) → Can skip\n# PriorityClass: NO replicas field (priority resource) → Can skip\n# ConfigMap: NO replicas field (configuration resource) → Can skip\n# StorageClass: NO replicas field (storage resource) → Can skip\n# CustomResourceDefinition: NO replicas field (schema definition) → Can skip\n# Policy: NO replicas field (policy resource) → Can skip\n# Ingress: NO replicas field (networking resource) → Can skip\n# Namespace: NO replicas field (namespace resource) → Can skip\n# Event: NO replicas field (event resource) → Can skip\n# Endpoints: NO replicas field (networking resource) → Can skip\n# CertificateSigningRequest: NO replicas field (certificate resource) → Can skip\n# VolumeAttributesClass: NO replicas field (storage resource) → Can skip\n# ephemeralreports.reports.kyverno.io: NO replicas field (reporting resource) → Can skip\n# imagevalidatingpolicies.policies.kyverno.io: NO replicas field (policy resource) → Can skip\n# ServiceAccount: NO replicas field (identity resource) → Can skip\n# backups.postgresql.cnpg.io: NO replicas field (backup resource) → Can skip\n# updaterequests.kyverno.io: NO replicas field (update resource) → Can skip\n# ClusterCleanupPolicy: NO replicas field (policy resource) → Can skip\n# ImageValidatingPolicy: NO replicas field (policy resource) → Can skip\n# clustercleanuppolicies.kyverno.io: NO replicas field (policy resource) → Can skip\n# NetworkPolicy: NO replicas field (networking resource) → Can skip\n# MutatingPolicy: NO replicas field (policy resource) → Can skip\n# mutatingpolicies.policies.kyverno.io: NO replicas field (policy resource) → Can skip\n# EphemeralReport: NO replicas field (reporting resource) → Can skip\n#\n# RESOURCES REQUIRING VALIDATION RULES: ReplicationController, ReplicaSet, Deployment, \n# clusters.postgresql.cnpg.io, StatefulSet, poolers.postgresql.cnpg.io\n#\napiVersion: kyverno.io/v1\nkind: ClusterPolicy\nmetadata:\n  name: require-replica-count-for-high-availability\n  labels:\n    policy-intent/id: \"2bd97213-3345-482e-9b72-fd156e9590fd\"\n  annotations:\n    policy-intent/description: \"All deployments must specify replica count for high availability\"\n    policy-intent/rationale: \"Ensures high availability by requiring multiple instances\"\n    policies.kyverno.io/title: \"Require Replica Count for High Availability\"\n    policies.kyverno.io/category: \"High Availability\"\n    policies.kyverno.io/severity: \"medium\"\n    policies.kyverno.io/description: >-\n      This policy enforces that workload resources explicitly specify a replica count\n      to ensure high availability. Resources must define their desired number of instances\n      rather than relying on defaults.\nspec:\n  background: false\n  validationFailureAction: Enforce\n  rules:\n  - name: validate-deployment-replicas\n    match:\n      any:\n      - resources:\n          kinds:\n          - apps/v1/Deployment\n          operations:\n          - CREATE\n          - UPDATE\n    validate:\n      cel:\n        expressions:\n        - expression: >-\n            has(object.spec) && has(object.spec.replicas)\n          message: \"Deployments must explicitly specify spec.replicas for high availability\"\n  - name: validate-replicaset-replicas\n    match:\n      any:\n      - resources:\n          kinds:\n          - apps/v1/ReplicaSet\n          operations:\n          - CREATE\n          - UPDATE\n    validate:\n      cel:\n        expressions:\n        - expression: >-\n            has(object.spec) && has(object.spec.replicas)\n          message: \"ReplicaSets must explicitly specify spec.replicas for high availability\"\n  - name: validate-statefulset-replicas\n    match:\n      any:\n      - resources:\n          kinds:\n          - apps/v1/StatefulSet\n          operations:\n          - CREATE\n          - UPDATE\n    validate:\n      cel:\n        expressions:\n        - expression: >-\n            has(object.spec) && has(object.spec.replicas)\n          message: \"StatefulSets must explicitly specify spec.replicas for high availability\"\n  - name: validate-replicationcontroller-replicas\n    match:\n      any:\n      - resources:\n          kinds:\n          - ReplicationController\n          operations:\n          - CREATE\n          - UPDATE\n    validate:\n      cel:\n        expressions:\n        - expression: >-\n            has(object.spec) && has(object.spec.replicas)\n          message: \"ReplicationControllers must explicitly specify spec.replicas for high availability\"\n  - name: validate-postgresql-cluster-instances\n    match:\n      any:\n      - resources:\n          kinds:\n          - postgresql.cnpg.io/v1/Cluster\n          operations:\n          - CREATE\n          - UPDATE\n    validate:\n      cel:\n        expressions:\n        - expression: >-\n            has(object.spec) && has(object.spec.instances)\n          message: \"PostgreSQL Clusters must explicitly specify spec.instances for high availability\"\n  - name: validate-postgresql-pooler-instances\n    match:\n      any:\n      - resources:\n          kinds:\n          - postgresql.cnpg.io/v1/Pooler\n          operations:\n          - CREATE\n          - UPDATE\n    validate:\n      cel:\n        expressions:\n        - expression: >-\n            has(object.spec) && has(object.spec.instances)\n          message: \"PostgreSQL Poolers must explicitly specify spec.instances for high availability\"","performance":{"duration_ms":27144,"input_tokens":182814,"output_tokens":1979,"total_tokens":184793,"sdk":"vercel","model_version":"claude-sonnet-4-5-20250929","iterations":1,"tool_calls_executed":0,"cache_read_tokens":0,"cache_creation_tokens":0},"metadata":{"timestamp":"2025-10-12T18:08:34.558Z","complexity":"medium","tags":["troubleshooting"],"source":"integration_test","tool":"policy","test_scenario":"policy-kyverno-generation","failure_analysis":""}}
